@using static IRRRL.Web.Pages.Veteran.Apply

<h4 class="mb-4">Property Information</h4>

<EditForm Model="@Model" OnValidSubmit="HandleNext">
    <DataAnnotationsValidator />

    <div class="mb-3">
        <label class="form-label">Property Address</label>
        <InputText @bind-Value="Model.PropertyAddress" @bind-Value:after="ClearEstimate" class="form-control" placeholder="123 Main Street" />
        <ValidationMessage For="@(() => Model.PropertyAddress)" class="text-danger" />
    </div>

    <div class="row">
        <div class="col-md-5 mb-3">
            <label class="form-label">City</label>
            <InputText @bind-Value="Model.City" class="form-control" placeholder="San Diego" />
            <ValidationMessage For="@(() => Model.City)" class="text-danger" />
        </div>

        <div class="col-md-3 mb-3">
            <label class="form-label">State</label>
            <InputSelect @bind-Value="Model.State" class="form-select">
                <option value="">Select State</option>
                <option value="AL">Alabama</option>
                <option value="AK">Alaska</option>
                <option value="AZ">Arizona</option>
                <option value="AR">Arkansas</option>
                <option value="CA">California</option>
                <option value="CO">Colorado</option>
                <option value="CT">Connecticut</option>
                <option value="DE">Delaware</option>
                <option value="FL">Florida</option>
                <option value="GA">Georgia</option>
                <option value="HI">Hawaii</option>
                <option value="ID">Idaho</option>
                <option value="IL">Illinois</option>
                <option value="IN">Indiana</option>
                <option value="IA">Iowa</option>
                <option value="KS">Kansas</option>
                <option value="KY">Kentucky</option>
                <option value="LA">Louisiana</option>
                <option value="ME">Maine</option>
                <option value="MD">Maryland</option>
                <option value="MA">Massachusetts</option>
                <option value="MI">Michigan</option>
                <option value="MN">Minnesota</option>
                <option value="MS">Mississippi</option>
                <option value="MO">Missouri</option>
                <option value="MT">Montana</option>
                <option value="NE">Nebraska</option>
                <option value="NV">Nevada</option>
                <option value="NH">New Hampshire</option>
                <option value="NJ">New Jersey</option>
                <option value="NM">New Mexico</option>
                <option value="NY">New York</option>
                <option value="NC">North Carolina</option>
                <option value="ND">North Dakota</option>
                <option value="OH">Ohio</option>
                <option value="OK">Oklahoma</option>
                <option value="OR">Oregon</option>
                <option value="PA">Pennsylvania</option>
                <option value="RI">Rhode Island</option>
                <option value="SC">South Carolina</option>
                <option value="SD">South Dakota</option>
                <option value="TN">Tennessee</option>
                <option value="TX">Texas</option>
                <option value="UT">Utah</option>
                <option value="VT">Vermont</option>
                <option value="VA">Virginia</option>
                <option value="WA">Washington</option>
                <option value="WV">West Virginia</option>
                <option value="WI">Wisconsin</option>
                <option value="WY">Wyoming</option>
            </InputSelect>
            <ValidationMessage For="@(() => Model.State)" class="text-danger" />
        </div>

        <div class="col-md-4 mb-3">
            <label class="form-label">ZIP Code</label>
            <InputText @bind-Value="Model.ZipCode" @bind-Value:after="ClearEstimate" class="form-control" placeholder="92101" />
            <ValidationMessage For="@(() => Model.ZipCode)" class="text-danger" />
        </div>
    </div>

    <div class="row mb-3">
        <div class="col-12">
            <button type="button" class="btn btn-outline-primary" @onclick="EstimateHomeValue" disabled="@isEstimating">
                @if (isEstimating)
                {
                    <span class="spinner-border spinner-border-sm me-2"></span>
                    <span>Estimating...</span>
                }
                else
                {
                    <span>üìä Get Estimated Home Value</span>
                }
            </button>
        </div>
    </div>

    @if (estimatedValue > 0)
    {
        <div class="alert alert-success">
            <h6 class="alert-heading">Estimated Home Value</h6>
            <div class="h4 mb-2">$@estimatedValue.ToString("N0")</div>
            <small>This is an automated estimate based on public records and recent sales in your area.</small>
        </div>
    }
    @if (!string.IsNullOrEmpty(estimateError))
    {
        <div class="alert alert-warning">
            <strong>Unable to estimate:</strong> @estimateError
            <br /><small>You can continue without an estimate. A loan officer will verify the value later.</small>
        </div>
    }

    <div class="row">
        <div class="col-md-6 mb-3">
            <label class="form-label">Property Type</label>
            <InputSelect @bind-Value="Model.PropertyType" class="form-select">
                <option value="SingleFamily">Single Family Home</option>
                <option value="Condo">Condominium</option>
                <option value="Townhouse">Townhouse</option>
                <option value="MultiUnit">Multi-Unit (2-4 units)</option>
            </InputSelect>
            <ValidationMessage For="@(() => Model.PropertyType)" class="text-danger" />
        </div>

        <div class="col-md-6 mb-3">
            <label class="form-label">Occupancy</label>
            <InputSelect @bind-Value="Model.Occupancy" class="form-select">
                <option value="PrimaryResidence">Primary Residence</option>
                <option value="SecondHome">Second Home</option>
                <option value="Investment">Investment Property</option>
            </InputSelect>
            <ValidationMessage For="@(() => Model.Occupancy)" class="text-danger" />
        </div>
    </div>

    <div class="row">
        <div class="col-md-4 mb-3">
            <label class="form-label">Number of Units</label>
            <InputSelect @bind-Value="Model.NumberOfUnits" class="form-select">
                <option value="1">1 Unit</option>
                <option value="2">2 Units</option>
                <option value="3">3 Units</option>
                <option value="4">4 Units</option>
            </InputSelect>
            <ValidationMessage For="@(() => Model.NumberOfUnits)" class="text-danger" />
            <small class="text-muted">VA loans allow up to 4 units</small>
        </div>

        <div class="col-md-4 mb-3">
            <label class="form-label">Year Built</label>
            <InputNumber @bind-Value="Model.YearBuilt" class="form-control" placeholder="2005" min="1800" max="2025" />
            <ValidationMessage For="@(() => Model.YearBuilt)" class="text-danger" />
        </div>

        <div class="col-md-4 mb-3">
            <label class="form-label">Date Acquired</label>
            <InputDate @bind-Value="Model.PropertyAcquiredDate" class="form-control" />
            <ValidationMessage For="@(() => Model.PropertyAcquiredDate)" class="text-danger" />
            <small class="text-muted">When you purchased it</small>
        </div>
    </div>

    <div class="alert alert-warning" role="alert">
        <strong>‚ö†Ô∏è Important:</strong> IRRRL requires that you previously occupied this property as your primary residence. 
        You may now use it as a rental or second home, but it must have been your primary residence at some point.
    </div>

    <div class="d-flex justify-content-between mt-4">
        <button type="button" class="btn btn-outline-secondary btn-lg" @onclick="HandleBack">
            ‚Üê Back
        </button>
        <button type="submit" class="btn btn-primary btn-lg">
            Next: Review Application ‚Üí
        </button>
    </div>
</EditForm>

@code {
    [Parameter] public ApplicationFormModel Model { get; set; } = new();
    [Parameter] public EventCallback OnNext { get; set; }
    [Parameter] public EventCallback OnBack { get; set; }

    private bool isEstimating = false;
    private decimal estimatedValue = 0;
    private string estimateError = "";

    private void ClearEstimate()
    {
        estimatedValue = 0;
        estimateError = "";
    }

    private async Task EstimateHomeValue()
    {
        if (string.IsNullOrWhiteSpace(Model.PropertyAddress) || 
            string.IsNullOrWhiteSpace(Model.City) || 
            string.IsNullOrWhiteSpace(Model.State) || 
            string.IsNullOrWhiteSpace(Model.ZipCode))
        {
            estimateError = "Please fill in the complete address first.";
            return;
        }

        isEstimating = true;
        estimateError = "";
        estimatedValue = 0;

        try
        {
            // TODO: Integrate with a property data API
            // Options: Zillow API, Realty Mole, Attom Data, RealtyAPI.co
            // For now, simulate an API call
            await Task.Delay(1500);
            
            // Simulated response - in production, this would be from an API
            estimatedValue = 350000; // Example value
            Model.EstimatedHomeValue = estimatedValue;
        }
        catch (Exception ex)
        {
            estimateError = "Unable to retrieve estimate at this time.";
        }
        finally
        {
            isEstimating = false;
        }
    }

    private async Task HandleNext()
    {
        await OnNext.InvokeAsync();
    }

    private async Task HandleBack()
    {
        await OnBack.InvokeAsync();
    }
}

