@page "/veteran/apply"
@using Microsoft.AspNetCore.Authorization
@using IRRRL.Core.Enums
@attribute [Authorize(Roles = "Veteran")]
@inject NavigationManager NavigationManager

<PageTitle>Apply for IRRRL</PageTitle>

<div class="container-fluid">
    <div class="row mb-3">
        <div class="col-12">
            <h2>IRRRL Application</h2>
            <p class="text-muted">Complete the following steps to apply for an Interest Rate Reduction Refinance Loan</p>
        </div>
    </div>

    <!-- Progress Steps -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                @for (int i = 1; i <= 8; i++)
                {
                    var stepNumber = i;
                    var isActive = currentStep == stepNumber;
                    var isCompleted = currentStep > stepNumber;
                    var stepClass = isActive ? "bg-primary text-white" : isCompleted ? "bg-success text-white" : "bg-secondary text-white";

                    <div class="d-flex align-items-center flex-grow-1">
                        <div class="@($"rounded-circle d-flex align-items-center justify-content-center {stepClass}")" 
                             style="width: 40px; height: 40px; font-weight: bold;">
                            @if (isCompleted)
                            {
                                <span>âœ“</span>
                            }
                            else
                            {
                                <span>@stepNumber</span>
                            }
                        </div>
                        <div class="ms-2 flex-grow-1">
                            <div class="fw-bold">@GetStepTitle(stepNumber)</div>
                            <small class="text-muted">@GetStepDescription(stepNumber)</small>
                        </div>
                        @if (i < 8)
                        {
                            <div class="flex-grow-1 border-top mx-3"></div>
                        }
                    </div>
                }
            </div>
        </div>
    </div>

    <!-- Form Content -->
    <div class="row">
        <div class="col-lg-8 offset-lg-2">
            <div class="card shadow">
                <div class="card-body p-4">
                    @if (currentStep == 1)
                    {
                        <PersonalInfoStep 
                            Model="@applicationModel" 
                            OnNext="NextStep" />
                    }
                    else if (currentStep == 2)
                    {
                        <CurrentAddressStep 
                            Model="@applicationModel" 
                            OnNext="NextStep" 
                            OnBack="PreviousStep" />
                    }
                    else if (currentStep == 3)
                    {
                        <MilitaryServiceStep 
                            Model="@applicationModel" 
                            OnNext="NextStep" 
                            OnBack="PreviousStep" />
                    }
                    else if (currentStep == 4)
                    {
                        <CurrentLoanStep 
                            Model="@applicationModel" 
                            OnNext="NextStep" 
                            OnBack="PreviousStep" />
                    }
                    else if (currentStep == 5)
                    {
                        <PropertyInfoStep 
                            Model="@applicationModel" 
                            OnNext="NextStep" 
                            OnBack="PreviousStep" />
                    }
                    else if (currentStep == 6)
                    {
                        <DeclarationsStep 
                            Model="@applicationModel" 
                            OnNext="NextStep" 
                            OnBack="PreviousStep" />
                    }
                    else if (currentStep == 7)
                    {
                        <DemographicsStep 
                            Model="@applicationModel" 
                            OnNext="NextStep" 
                            OnBack="PreviousStep" />
                    }
                    else if (currentStep == 8)
                    {
                        <ReviewAndSubmitStep 
                            Model="@applicationModel" 
                            OnBack="PreviousStep" 
                            OnSubmit="SubmitApplication" />
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private int currentStep = 1;
    private ApplicationFormModel applicationModel = new();

    private void NextStep()
    {
        if (currentStep < 8)
        {
            currentStep++;
        }
    }

    private void PreviousStep()
    {
        if (currentStep > 1)
        {
            currentStep--;
        }
    }

    private string GetStepTitle(int step)
    {
        return step switch
        {
            1 => "Personal Info",
            2 => "Current Address",
            3 => "Military Service",
            4 => "Current Loan",
            5 => "Property Info",
            6 => "Declarations",
            7 => "Demographics",
            8 => "Review & Submit",
            _ => ""
        };
    }

    private string GetStepDescription(int step)
    {
        return step switch
        {
            1 => "Contact & citizenship",
            2 => "Residency history",
            3 => "VA eligibility",
            4 => "Existing VA loan",
            5 => "Property details",
            6 => "Legal disclosures",
            7 => "Optional (HMDA)",
            8 => "Final review",
            _ => ""
        };
    }

    private async Task SubmitApplication()
    {
        // TODO: Submit to backend API
        // For now, simulate submission and redirect to confirmation
        await Task.Delay(500);
        NavigationManager.NavigateTo("/veteran/confirmation");
    }

    // Model for the application form
    public class ApplicationFormModel
    {
        // Personal Info
        public string FirstName { get; set; } = "";
        public string LastName { get; set; } = "";
        public DateTime? DateOfBirth { get; set; }
        public string SSN { get; set; } = "";
        public string PhoneNumber { get; set; } = "";
        public string Email { get; set; } = "";
        public string CitizenshipStatus { get; set; } = "";
        public string MaritalStatus { get; set; } = "";
        public string SpouseFirstName { get; set; } = "";
        public string SpouseLastName { get; set; } = "";
        
        // Current Address
        public string CurrentStreetAddress { get; set; } = "";
        public string CurrentCity { get; set; } = "";
        public string CurrentState { get; set; } = "";
        public string CurrentZipCode { get; set; } = "";
        public int YearsAtCurrentAddress { get; set; }
        public int MonthsAtCurrentAddress { get; set; }
        public string CurrentHousingStatus { get; set; } = "";
        public decimal CurrentMonthlyHousingPayment { get; set; }
        
        // Previous Address (if < 2 years at current)
        public string PreviousStreetAddress { get; set; } = "";
        public string PreviousCity { get; set; } = "";
        public string PreviousState { get; set; } = "";
        public string PreviousZipCode { get; set; } = "";
        public int YearsAtPreviousAddress { get; set; }
        public int MonthsAtPreviousAddress { get; set; }
        
        // Military Service
        public string MilitaryBranch { get; set; } = "";
        public string MilitaryStatus { get; set; } = "";
        public DateTime? MilitaryServiceStartDate { get; set; }
        public DateTime? MilitaryServiceEndDate { get; set; }
        public string VADisabilityRating { get; set; } = "";
        public string VACaseNumber { get; set; } = "";
        public bool IsFirstTimeVALoan { get; set; }
        
        // Demographics (Optional)
        public string Gender { get; set; } = "";
        public string Ethnicity { get; set; } = "";
        public bool RaceAmericanIndian { get; set; }
        public bool RaceAsian { get; set; }
        public bool RaceBlack { get; set; }
        public bool RacePacificIslander { get; set; }
        public bool RaceWhite { get; set; }

        // Current Loan Info
        public decimal CurrentLoanAmount { get; set; }
        public decimal CurrentInterestRate { get; set; }
        public decimal CurrentMonthlyPayment { get; set; }
        public int RemainingTermMonths { get; set; }
        public string LoanNumber { get; set; } = "";
        public DateTime? OriginalLoanDate { get; set; }

        // Property Info
        public string PropertyAddress { get; set; } = "";
        public string City { get; set; } = "";
        public string State { get; set; } = "";
        public string ZipCode { get; set; } = "";
        public string PropertyType { get; set; } = "SingleFamily";
        public string Occupancy { get; set; } = "PrimaryResidence";
        public decimal EstimatedHomeValue { get; set; }
        public int NumberOfUnits { get; set; } = 1;
        public int? YearBuilt { get; set; }
        public DateTime? PropertyAcquiredDate { get; set; }
        
        // Declarations
        public bool IntendToOccupyProperty { get; set; }
        public bool HasOutstandingJudgments { get; set; }
        public bool HasBankruptcy { get; set; }
        public string BankruptcyType { get; set; } = "";
        public DateTime? BankruptcyDischargeDate { get; set; }
        public bool HasForeclosure { get; set; }
        public DateTime? ForeclosureCompletionDate { get; set; }
        public bool IsPartyToLawsuit { get; set; }
        public bool HasDelinquentFederalDebt { get; set; }
        public bool HasAlimonyChildSupport { get; set; }
        public decimal? AlimonyChildSupportAmount { get; set; }

        // New Loan Terms
        public decimal DesiredInterestRate { get; set; }
        public int DesiredTermMonths { get; set; } = 360;
        public bool IncludeFundingFeeInLoan { get; set; } = true;
    }
}

