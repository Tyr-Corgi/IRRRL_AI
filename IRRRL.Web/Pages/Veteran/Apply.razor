@page "/veteran/apply"
@using Microsoft.AspNetCore.Authorization
@using IRRRL.Core.Enums
@using IRRRL.Core.Entities
@using IRRRL.Web.Features.Veteran.SubmitApplication
@using MediatR
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@attribute [Authorize(Roles = "Veteran")]
@inject NavigationManager NavigationManager
@inject IMediator Mediator
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject ILogger<Apply> Logger

<PageTitle>Apply for IRRRL</PageTitle>

<div class="container-fluid">
    <div class="row mb-3">
        <div class="col-12">
            <h2>IRRRL Application</h2>
            <p class="text-muted">Complete the following steps to apply for an Interest Rate Reduction Refinance Loan</p>
        </div>
    </div>

    <!-- Progress Steps -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                @for (int i = 1; i <= 9; i++)
                {
                    var stepNumber = i;
                    var isActive = currentStep == stepNumber;
                    var isCompleted = currentStep > stepNumber;
                    var stepClass = isActive ? "bg-primary text-white" : isCompleted ? "bg-success text-white" : "bg-secondary text-white";

                    <div class="d-flex align-items-center flex-grow-1">
                        <div class="@($"rounded-circle d-flex align-items-center justify-content-center {stepClass}")" 
                             style="width: 40px; height: 40px; font-weight: bold;">
                            @if (isCompleted)
                            {
                                <span>âœ“</span>
                            }
                            else
                            {
                                <span>@stepNumber</span>
                            }
                        </div>
                        <div class="ms-2 flex-grow-1">
                            <div class="fw-bold">@GetStepTitle(stepNumber)</div>
                            <small class="text-muted">@GetStepDescription(stepNumber)</small>
                        </div>
                        @if (i < 9)
                        {
                            <div class="flex-grow-1 border-top mx-3"></div>
                        }
                    </div>
                }
            </div>
        </div>
    </div>

    <!-- Form Content -->
    <div class="row">
        <div class="col-lg-8 offset-lg-2">
            <div class="card shadow">
                <div class="card-body p-4">
                    @if (currentStep == 1)
                    {
                        <PersonalInfoStep 
                            Model="@applicationModel" 
                            OnNext="NextStep" />
                    }
                    else if (currentStep == 2)
                    {
                        <CurrentAddressStep 
                            Model="@applicationModel" 
                            OnNext="NextStep" 
                            OnBack="PreviousStep" />
                    }
                    else if (currentStep == 3)
                    {
                        <MilitaryServiceStep 
                            Model="@applicationModel" 
                            OnNext="NextStep" 
                            OnBack="PreviousStep" />
                    }
                    else if (currentStep == 4)
                    {
                        <CurrentLoanStep 
                            Model="@applicationModel" 
                            OnNext="NextStep" 
                            OnBack="PreviousStep" />
                    }
                    else if (currentStep == 5)
                    {
                        <NewLoanTermsStep 
                            Model="@applicationModel" 
                            OnNext="NextStep" 
                            OnBack="PreviousStep" />
                    }
                    else if (currentStep == 6)
                    {
                        <PropertyInfoStep 
                            Model="@applicationModel" 
                            OnNext="NextStep" 
                            OnBack="PreviousStep" />
                    }
                    else if (currentStep == 7)
                    {
                        <DeclarationsStep 
                            Model="@applicationModel" 
                            OnNext="NextStep" 
                            OnBack="PreviousStep" />
                    }
                    else if (currentStep == 8)
                    {
                        <DemographicsStep 
                            Model="@applicationModel" 
                            OnNext="NextStep" 
                            OnBack="PreviousStep" />
                    }
                    else if (currentStep == 9)
                    {
                        <ReviewAndSubmitStep 
                            Model="@applicationModel" 
                            OnBack="PreviousStep" 
                            OnSubmit="SubmitApplication" />
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private int currentStep = 1;
    private ApplicationFormModel applicationModel = new();

    private void NextStep()
    {
        if (currentStep < 9)
        {
            currentStep++;
        }
    }

    private void PreviousStep()
    {
        if (currentStep > 1)
        {
            currentStep--;
        }
    }

    private string GetStepTitle(int step)
    {
        return step switch
        {
            1 => "Personal Info",
            2 => "Current Address",
            3 => "Military Service",
            4 => "Current Loan",
            5 => "New Loan Terms",
            6 => "Property Info",
            7 => "Declarations",
            8 => "Demographics",
            9 => "Review & Submit",
            _ => ""
        };
    }

    private string GetStepDescription(int step)
    {
        return step switch
        {
            1 => "Contact & citizenship",
            2 => "Residency history",
            3 => "VA eligibility",
            4 => "Existing VA loan",
            5 => "Desired rate & term",
            6 => "Property details",
            7 => "Legal disclosures",
            8 => "Optional (HMDA)",
            9 => "Final review",
            _ => ""
        };
    }

    private async Task SubmitApplication()
    {
        try
        {
            // Get current user
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var userId = authState.User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            
            if (string.IsNullOrEmpty(userId))
            {
                Logger.LogError("User ID not found in claims");
                return;
            }

            // Map form model to entities
            var borrower = new Borrower
            {
                FirstName = applicationModel.FirstName,
                LastName = applicationModel.LastName,
                Email = applicationModel.Email,
                Phone = applicationModel.PhoneNumber,
                SSN = applicationModel.SSN,
                DateOfBirth = applicationModel.DateOfBirth ?? DateTime.MinValue,
                VAFileNumber = applicationModel.VACaseNumber,
                HasDisabilityRating = !string.IsNullOrEmpty(applicationModel.VADisabilityRating),
                DisabilityPercentage = int.TryParse(applicationModel.VADisabilityRating, out var rating) ? rating : null,
                StreetAddress = applicationModel.CurrentStreetAddress,
                City = applicationModel.CurrentCity,
                State = applicationModel.CurrentState,
                ZipCode = applicationModel.CurrentZipCode,
                UserId = userId
            };

            var property = new Property
            {
                StreetAddress = applicationModel.PropertyAddress,
                City = applicationModel.City,
                State = applicationModel.State,
                ZipCode = applicationModel.ZipCode,
                PropertyType = applicationModel.PropertyType,
                CurrentlyOccupied = applicationModel.Occupancy == "PrimaryResidence",
                PreviouslyOccupied = applicationModel.Occupancy == "PrimaryResidence",
                OccupancyStartDate = applicationModel.PropertyAcquiredDate,
                EstimatedValue = applicationModel.EstimatedHomeValue,
                YearBuilt = applicationModel.YearBuilt
            };

            var currentLoan = new CurrentLoan
            {
                LoanNumber = applicationModel.LoanNumber,
                CurrentBalance = applicationModel.CurrentLoanAmount,
                OriginalLoanAmount = applicationModel.CurrentLoanAmount,
                InterestRate = applicationModel.CurrentInterestRate,
                MonthlyPrincipalAndInterest = applicationModel.CurrentMonthlyPayment,
                TotalMonthlyPayment = applicationModel.CurrentMonthlyPayment,
                RemainingTermMonths = applicationModel.RemainingTermMonths,
                OriginalTermMonths = 360, // Assuming standard 30-year loan
                LoanType = LoanType.FixedRate, // Default, could make this selectable
                OriginationDate = applicationModel.OriginalLoanDate ?? DateTime.MinValue,
                Lender = "", // Not collected in form
                IsVALoan = true,
                CurrentOnPayments = true // Assuming for now
            };

            // Calculate funding fee
            var fundingFeeAmount = applicationModel.CurrentLoanAmount * 0.005m; // 0.5%
            var requestedLoanAmount = applicationModel.IncludeFundingFeeInLoan 
                ? applicationModel.CurrentLoanAmount + fundingFeeAmount 
                : applicationModel.CurrentLoanAmount;

            var application = new IRRRLApplication
            {
                ApplicationType = ApplicationType.RateAndTerm,
                Borrower = borrower,
                Property = property,
                CurrentLoan = currentLoan,
                RequestedLoanAmount = requestedLoanAmount,
                RequestedInterestRate = applicationModel.DesiredInterestRate,
                RequestedTermMonths = applicationModel.DesiredTermMonths,
                FundingFeeAmount = fundingFeeAmount,
                FundingFeeWaived = false,
                TotalClosingCosts = fundingFeeAmount, // Simplified - usually includes other costs
                TotalLoanCosts = fundingFeeAmount
            };

            // Submit via MediatR
            var result = await Mediator.Send(new SubmitApplicationCommand(userId, application));

            if (result.IsSuccess)
            {
                Logger.LogInformation("Application {ApplicationNumber} submitted successfully", result.Value);
                NavigationManager.NavigateTo($"/veteran/confirmation?appNumber={result.Value}");
            }
            else
            {
                Logger.LogError("Failed to submit application: {Error}", result.Error);
                // TODO: Show error message to user
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error submitting application");
            // TODO: Show error message to user
        }
    }

    // Model for the application form
    public class ApplicationFormModel
    {
        // Personal Info
        public string FirstName { get; set; } = "";
        public string LastName { get; set; } = "";
        public DateTime? DateOfBirth { get; set; }
        public string SSN { get; set; } = "";
        public string PhoneNumber { get; set; } = "";
        public string Email { get; set; } = "";
        public string CitizenshipStatus { get; set; } = "";
        public string MaritalStatus { get; set; } = "";
        public string SpouseFirstName { get; set; } = "";
        public string SpouseLastName { get; set; } = "";
        
        // Current Address
        public string CurrentStreetAddress { get; set; } = "";
        public string CurrentCity { get; set; } = "";
        public string CurrentState { get; set; } = "";
        public string CurrentZipCode { get; set; } = "";
        public int YearsAtCurrentAddress { get; set; }
        public int MonthsAtCurrentAddress { get; set; }
        public string CurrentHousingStatus { get; set; } = "";
        public decimal CurrentMonthlyHousingPayment { get; set; }
        
        // Previous Address (if < 2 years at current)
        public string PreviousStreetAddress { get; set; } = "";
        public string PreviousCity { get; set; } = "";
        public string PreviousState { get; set; } = "";
        public string PreviousZipCode { get; set; } = "";
        public int YearsAtPreviousAddress { get; set; }
        public int MonthsAtPreviousAddress { get; set; }
        
        // Military Service
        public string MilitaryBranch { get; set; } = "";
        public string MilitaryStatus { get; set; } = "";
        public DateTime? MilitaryServiceStartDate { get; set; }
        public DateTime? MilitaryServiceEndDate { get; set; }
        public string VADisabilityRating { get; set; } = "";
        public string VACaseNumber { get; set; } = "";
        public bool IsFirstTimeVALoan { get; set; }
        
        // Demographics (Optional)
        public string Gender { get; set; } = "";
        public string Ethnicity { get; set; } = "";
        public bool RaceAmericanIndian { get; set; }
        public bool RaceAsian { get; set; }
        public bool RaceBlack { get; set; }
        public bool RacePacificIslander { get; set; }
        public bool RaceWhite { get; set; }

        // Current Loan Info
        public decimal CurrentLoanAmount { get; set; }
        public decimal CurrentInterestRate { get; set; }
        public decimal CurrentMonthlyPayment { get; set; }
        public int RemainingTermMonths { get; set; }
        public string LoanNumber { get; set; } = "";
        public DateTime? OriginalLoanDate { get; set; }

        // Property Info
        public string PropertyAddress { get; set; } = "";
        public string City { get; set; } = "";
        public string State { get; set; } = "";
        public string ZipCode { get; set; } = "";
        public string PropertyType { get; set; } = "SingleFamily";
        public string Occupancy { get; set; } = "PrimaryResidence";
        public decimal EstimatedHomeValue { get; set; }
        public int NumberOfUnits { get; set; } = 1;
        public int? YearBuilt { get; set; }
        public DateTime? PropertyAcquiredDate { get; set; }
        
        // Declarations
        public bool IntendToOccupyProperty { get; set; }
        public bool HasOutstandingJudgments { get; set; }
        public bool HasBankruptcy { get; set; }
        public string BankruptcyType { get; set; } = "";
        public DateTime? BankruptcyDischargeDate { get; set; }
        public bool HasForeclosure { get; set; }
        public DateTime? ForeclosureCompletionDate { get; set; }
        public bool IsPartyToLawsuit { get; set; }
        public bool HasDelinquentFederalDebt { get; set; }
        public bool HasAlimonyChildSupport { get; set; }
        public decimal? AlimonyChildSupportAmount { get; set; }

        // New Loan Terms
        public decimal DesiredInterestRate { get; set; }
        public int DesiredTermMonths { get; set; } = 360;
        public bool IncludeFundingFeeInLoan { get; set; } = true;
    }
}

