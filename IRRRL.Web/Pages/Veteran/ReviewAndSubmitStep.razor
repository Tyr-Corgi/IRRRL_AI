@using static IRRRL.Web.Pages.Veteran.Apply

<h4 class="mb-4">Review Your Application</h4>

<div class="card mb-3">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <strong>Personal Information</strong>
        <button type="button" class="btn btn-sm btn-light" @onclick="() => EditStep(1)">Edit</button>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6 mb-2">
                <small class="text-muted">Name</small>
                <div><strong>@Model.FirstName @Model.LastName</strong></div>
            </div>
            <div class="col-md-6 mb-2">
                <small class="text-muted">Date of Birth</small>
                <div><strong>@Model.DateOfBirth?.ToString("MM/dd/yyyy")</strong></div>
            </div>
            <div class="col-md-6 mb-2">
                <small class="text-muted">Phone</small>
                <div><strong>@Model.PhoneNumber</strong></div>
            </div>
            <div class="col-md-6 mb-2">
                <small class="text-muted">Email</small>
                <div><strong>@Model.Email</strong></div>
            </div>
            <div class="col-md-6 mb-2">
                <small class="text-muted">SSN</small>
                <div><strong>***-**-@Model.SSN?.Substring(Math.Max(0, Model.SSN.Length - 4))</strong></div>
            </div>
            <div class="col-md-6 mb-2">
                <small class="text-muted">Citizenship</small>
                <div><strong>@Model.CitizenshipStatus</strong></div>
            </div>
            <div class="col-md-6 mb-2">
                <small class="text-muted">Marital Status</small>
                <div><strong>@Model.MaritalStatus</strong></div>
            </div>
            @if (!string.IsNullOrEmpty(Model.SpouseFirstName))
            {
                <div class="col-md-6 mb-2">
                    <small class="text-muted">Spouse Name</small>
                    <div><strong>@Model.SpouseFirstName @Model.SpouseLastName</strong></div>
                </div>
            }
        </div>
    </div>
</div>

<div class="card mb-3">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <strong>Current Address</strong>
        <button type="button" class="btn btn-sm btn-light" @onclick="() => EditStep(2)">Edit</button>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-12 mb-2">
                <small class="text-muted">Address</small>
                <div><strong>@Model.CurrentStreetAddress</strong></div>
                <div><strong>@Model.CurrentCity, @Model.CurrentState @Model.CurrentZipCode</strong></div>
            </div>
            <div class="col-md-6 mb-2">
                <small class="text-muted">Time at Address</small>
                <div><strong>@Model.YearsAtCurrentAddress years, @Model.MonthsAtCurrentAddress months</strong></div>
            </div>
            <div class="col-md-6 mb-2">
                <small class="text-muted">Housing Status</small>
                <div><strong>@Model.CurrentHousingStatus - $@Model.CurrentMonthlyHousingPayment.ToString("N0")/month</strong></div>
            </div>
        </div>
    </div>
</div>

<div class="card mb-3">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <strong>Military Service</strong>
        <button type="button" class="btn btn-sm btn-light" @onclick="() => EditStep(3)">Edit</button>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6 mb-2">
                <small class="text-muted">Branch</small>
                <div><strong>@Model.MilitaryBranch</strong></div>
            </div>
            <div class="col-md-6 mb-2">
                <small class="text-muted">Status</small>
                <div><strong>@Model.MilitaryStatus</strong></div>
            </div>
            <div class="col-md-6 mb-2">
                <small class="text-muted">Service Dates</small>
                <div><strong>@Model.MilitaryServiceStartDate?.ToString("MM/yyyy") - @(Model.MilitaryServiceEndDate?.ToString("MM/yyyy") ?? "Present")</strong></div>
            </div>
            @if (!string.IsNullOrEmpty(Model.VADisabilityRating))
            {
                <div class="col-md-6 mb-2">
                    <small class="text-muted">VA Disability Rating</small>
                    <div><strong>@Model.VADisabilityRating%</strong></div>
                </div>
            }
        </div>
    </div>
</div>

<div class="card mb-3">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <strong>Current Loan Information</strong>
        <button type="button" class="btn btn-sm btn-light" @onclick="() => EditStep(4)">Edit</button>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6 mb-2">
                <small class="text-muted">Loan Amount</small>
                <div><strong>$@Model.CurrentLoanAmount.ToString("N2")</strong></div>
            </div>
            <div class="col-md-6 mb-2">
                <small class="text-muted">Interest Rate</small>
                <div><strong>@Model.CurrentInterestRate%</strong></div>
            </div>
            <div class="col-md-6 mb-2">
                <small class="text-muted">Monthly Payment</small>
                <div><strong>$@Model.CurrentMonthlyPayment.ToString("N2")</strong></div>
            </div>
            <div class="col-md-6 mb-2">
                <small class="text-muted">Remaining Term</small>
                <div><strong>@Model.RemainingTermMonths months</strong></div>
            </div>
            <div class="col-md-6 mb-2">
                <small class="text-muted">VA Loan Number</small>
                <div><strong>@Model.LoanNumber</strong></div>
            </div>
            <div class="col-md-6 mb-2">
                <small class="text-muted">Original Loan Date</small>
                <div><strong>@Model.OriginalLoanDate?.ToString("MM/dd/yyyy")</strong></div>
            </div>
        </div>
    </div>
</div>

<div class="card mb-3">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <strong>Property Information</strong>
        <button type="button" class="btn btn-sm btn-light" @onclick="() => EditStep(5)">Edit</button>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-12 mb-2">
                <small class="text-muted">Address</small>
                <div><strong>@Model.PropertyAddress</strong></div>
                <div><strong>@Model.City, @Model.State @Model.ZipCode</strong></div>
            </div>
            <div class="col-md-6 mb-2">
                <small class="text-muted">Property Type</small>
                <div><strong>@Model.PropertyType</strong></div>
            </div>
            <div class="col-md-6 mb-2">
                <small class="text-muted">Occupancy</small>
                <div><strong>@Model.Occupancy</strong></div>
            </div>
        </div>
    </div>
</div>

@if (Model.EstimatedHomeValue > 0)
{
    <div class="card mb-3">
        <div class="card-header bg-primary text-white">
            <strong>Estimated Home Value</strong>
        </div>
        <div class="card-body">
            <div class="h4 text-success">$@Model.EstimatedHomeValue.ToString("N0")</div>
            <small class="text-muted">This estimate will be verified by the loan officer.</small>
        </div>
    </div>
}

<div class="card mb-3">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <strong>Declarations</strong>
        <button type="button" class="btn btn-sm btn-light" @onclick="() => EditStep(6)">Edit</button>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6 mb-2">
                <small class="text-muted">Intent to Occupy</small>
                <div><strong>@(Model.IntendToOccupyProperty ? "Yes - Primary Residence" : "No - Not Primary Residence")</strong></div>
            </div>
            <div class="col-md-6 mb-2">
                <small class="text-muted">Outstanding Judgments</small>
                <div><strong>@(Model.HasOutstandingJudgments ? "Yes" : "No")</strong></div>
            </div>
            <div class="col-md-6 mb-2">
                <small class="text-muted">Bankruptcy (7 yrs)</small>
                <div><strong>@(Model.HasBankruptcy ? $"Yes - {Model.BankruptcyType}" : "No")</strong></div>
            </div>
            <div class="col-md-6 mb-2">
                <small class="text-muted">Foreclosure (7 yrs)</small>
                <div><strong>@(Model.HasForeclosure ? "Yes" : "No")</strong></div>
            </div>
            <div class="col-md-6 mb-2">
                <small class="text-muted">Party to Lawsuit</small>
                <div><strong>@(Model.IsPartyToLawsuit ? "Yes" : "No")</strong></div>
            </div>
            <div class="col-md-6 mb-2">
                <small class="text-muted">Delinquent Federal Debt</small>
                <div><strong>@(Model.HasDelinquentFederalDebt ? "Yes" : "No")</strong></div>
            </div>
            @if (Model.HasAlimonyChildSupport)
            {
                <div class="col-md-6 mb-2">
                    <small class="text-muted">Alimony/Child Support</small>
                    <div><strong>$@Model.AlimonyChildSupportAmount?.ToString("N0")/month</strong></div>
                </div>
            }
        </div>
    </div>
</div>

@if (!string.IsNullOrEmpty(Model.Gender) || !string.IsNullOrEmpty(Model.Ethnicity) || 
     Model.RaceAmericanIndian || Model.RaceAsian || Model.RaceBlack || Model.RacePacificIslander || Model.RaceWhite)
{
    <div class="card mb-3">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <strong>Demographics (Optional)</strong>
            <button type="button" class="btn btn-sm btn-light" @onclick="() => EditStep(7)">Edit</button>
        </div>
        <div class="card-body">
            <div class="row">
                @if (!string.IsNullOrEmpty(Model.Gender))
                {
                    <div class="col-md-6 mb-2">
                        <small class="text-muted">Gender</small>
                        <div><strong>@Model.Gender</strong></div>
                    </div>
                }
                @if (!string.IsNullOrEmpty(Model.Ethnicity))
                {
                    <div class="col-md-6 mb-2">
                        <small class="text-muted">Ethnicity</small>
                        <div><strong>@Model.Ethnicity</strong></div>
                    </div>
                }
            </div>
            @{
                var selectedRaces = new List<string>();
                if (Model.RaceAmericanIndian) selectedRaces.Add("American Indian or Alaska Native");
                if (Model.RaceAsian) selectedRaces.Add("Asian");
                if (Model.RaceBlack) selectedRaces.Add("Black or African American");
                if (Model.RacePacificIslander) selectedRaces.Add("Native Hawaiian or Other Pacific Islander");
                if (Model.RaceWhite) selectedRaces.Add("White");
            }
            @if (selectedRaces.Any())
            {
                <div class="mt-2">
                    <small class="text-muted">Race</small>
                    <div><strong>@string.Join(", ", selectedRaces)</strong></div>
                </div>
            }
        </div>
    </div>
}

<div class="alert alert-info">
    <h5 class="alert-heading">üìã What Happens Next</h5>
    <p class="mb-2">A loan officer will:</p>
    <ul class="mb-0">
        <li>Review your current loan details and verify eligibility</li>
        <li>Find the best interest rate available for you</li>
        <li>Calculate your potential savings</li>
        <li>Request any required documents</li>
        <li>Guide you through the refinance process</li>
    </ul>
</div>

<div class="card bg-light mb-4">
    <div class="card-body">
        <h5 class="text-center mb-3">üìã Next Steps After Submission</h5>
        <ol>
            <li class="mb-2">
                <strong>Application Review</strong> - A loan officer will review your application within 24-48 hours
            </li>
            <li class="mb-2">
                <strong>Document Collection</strong> - You'll receive a list of required documents to upload
            </li>
            <li class="mb-2">
                <strong>Verification</strong> - Our AI system will validate your documents and verify eligibility
            </li>
            <li class="mb-2">
                <strong>Underwriting</strong> - Your application will be submitted to an underwriter for final approval
            </li>
            <li class="mb-0">
                <strong>Closing</strong> - Once approved, we'll schedule your loan closing
            </li>
        </ol>
    </div>
</div>

<div class="form-check mb-4">
    <input class="form-check-input" type="checkbox" @bind="agreedToTerms" id="agreeTerms">
    <label class="form-check-label" for="agreeTerms">
        I certify that the information provided is accurate and complete to the best of my knowledge. 
        I authorize the lender to verify my VA loan eligibility and obtain necessary credit reports.
    </label>
</div>

<div class="d-flex justify-content-between mt-4">
    <button type="button" class="btn btn-outline-secondary btn-lg" @onclick="HandleBack">
        ‚Üê Back
    </button>
    <button type="button" class="btn btn-success btn-lg" disabled="@(!agreedToTerms || isSubmitting)" @onclick="HandleSubmit">
        @if (isSubmitting)
        {
            <span class="spinner-border spinner-border-sm me-2"></span>
            <span>Submitting...</span>
        }
        else
        {
            <span>Submit Application</span>
        }
    </button>
</div>

@code {
    [Parameter] public ApplicationFormModel Model { get; set; } = new();
    [Parameter] public EventCallback OnBack { get; set; }
    [Parameter] public EventCallback OnSubmit { get; set; }

    private bool agreedToTerms = false;
    private bool isSubmitting = false;

    private async Task HandleBack()
    {
        await OnBack.InvokeAsync();
    }

    private async Task HandleSubmit()
    {
        isSubmitting = true;
        await Task.Delay(1000); // Simulate API call
        await OnSubmit.InvokeAsync();
        isSubmitting = false;
    }

    private void EditStep(int step)
    {
        // This will be implemented to jump back to a specific step
        // For now, just go back
        HandleBack();
    }
}

