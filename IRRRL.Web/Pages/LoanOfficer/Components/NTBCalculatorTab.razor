@using static IRRRL.Web.Pages.Veteran.Apply

<div class="row">
    <div class="col-12">
        <div class="alert alert-info mb-4">
            <h5><span class="oi oi-calculator"></span> Net Tangible Benefit (NTB) Calculator</h5>
            <p class="mb-0">Verify that this refinance meets VA's Net Tangible Benefit requirements. For fixed-to-fixed, the new rate must be at least 0.5% lower. For ARM-to-fixed or reducing payment, different rules apply.</p>
        </div>
    </div>
</div>

<div class="row">
    <!-- Calculator Input -->
    <div class="col-lg-7 mb-3">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><span class="oi oi-wrench"></span> Loan Comparison</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- Current Loan Column -->
                    <div class="col-md-6">
                        <h6 class="text-primary mb-3">Current Loan</h6>
                        
                        <div class="mb-3">
                            <label class="form-label small">Loan Amount</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" @bind="currentLoanAmount" @bind:event="oninput" @onchange="Calculate" />
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label small">Interest Rate (%)</label>
                            <input type="number" class="form-control" step="0.001" @bind="currentInterestRate" @bind:event="oninput" @onchange="Calculate" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label small">Monthly P&I Payment</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" @bind="currentMonthlyPayment" @bind:event="oninput" @onchange="Calculate" />
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label small">Remaining Term (months)</label>
                            <input type="number" class="form-control" @bind="currentRemainingTerm" @bind:event="oninput" @onchange="Calculate" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label small">Loan Type</label>
                            <select class="form-select" @bind="currentLoanType" @onchange="Calculate">
                                <option value="Fixed">Fixed Rate</option>
                                <option value="ARM">ARM (Adjustable)</option>
                            </select>
                        </div>
                    </div>

                    <!-- New Loan Column -->
                    <div class="col-md-6">
                        <h6 class="text-success mb-3">New Loan (Proposed)</h6>
                        
                        <div class="mb-3">
                            <label class="form-label small">Loan Amount</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" @bind="newLoanAmount" @bind:event="oninput" @onchange="Calculate" />
                            </div>
                            <small class="text-muted">Include funding fee if rolled in</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label small">Interest Rate (%)</label>
                            <input type="number" class="form-control" step="0.001" @bind="newInterestRate" @bind:event="oninput" @onchange="Calculate" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label small">New Term (months)</label>
                            <input type="number" class="form-control" @bind="newTerm" @bind:event="oninput" @onchange="Calculate" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label small">Total Closing Costs</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" @bind="closingCosts" @bind:event="oninput" @onchange="Calculate" />
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label small">Disability Rating</label>
                            <select class="form-select" @bind="disabilityRating" @onchange="Calculate">
                                <option value="0">No Disability (0.5% fee)</option>
                                <option value="10">10% or higher (Waived)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="text-center mt-3">
                    <button class="btn btn-primary btn-lg" @onclick="Calculate">
                        <span class="oi oi-calculator"></span> Calculate NTB
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Column -->
    <div class="col-lg-5 mb-3">
        @if (calculated)
        {
            <div class="card mb-3 @(meetsNTB ? "border-success" : "border-danger")">
                <div class="card-header @(meetsNTB ? "bg-success" : "bg-danger") text-white">
                    <h5 class="mb-0">
                        @if (meetsNTB)
                        {
                            <span class="oi oi-check"></span> <text>Meets NTB ✓</text>
                        }
                        else
                        {
                            <span class="oi oi-x"></span> <text>Does NOT Meet NTB ✗</text>
                        }
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="text-muted small">Rate Reduction</label>
                        <div class="fs-4 fw-bold @(rateReduction >= 0.5m ? "text-success" : "text-danger")">
                            @rateReduction.ToString("0.000")%
                            @if (currentLoanType == "Fixed" && rateReduction < 0.5m)
                            {
                                <span class="badge bg-danger ms-2">Need 0.5%+</span>
                            }
                            else if (rateReduction >= 0.5m)
                            {
                                <span class="badge bg-success ms-2">✓</span>
                            }
                        </div>
                    </div>

                    <hr />

                    <div class="mb-3">
                        <label class="text-muted small">New Monthly P&I Payment</label>
                        <div class="fs-5 fw-bold">$@newMonthlyPayment.ToString("N2")</div>
                    </div>

                    <div class="mb-3">
                        <label class="text-muted small">Monthly Savings</label>
                        <div class="fs-4 fw-bold text-success">$@monthlySavings.ToString("N2")</div>
                        <small class="text-muted">(@annualSavings.ToString("N2") per year)</small>
                    </div>

                    <hr />

                    <div class="mb-3">
                        <label class="text-muted small">VA Funding Fee</label>
                        <div class="fw-bold">
                            @if (disabilityRating == "10")
                            {
                                <span class="text-success">$0.00 (Waived)</span>
                            }
                            else
                            {
                                <span>$@fundingFee.ToString("N2") (0.5%)</span>
                            }
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="text-muted small">Total Loan Costs</label>
                        <div class="fw-bold">$@totalCosts.ToString("N2")</div>
                    </div>

                    <div class="mb-3">
                        <label class="text-muted small">Recoupment Period</label>
                        <div class="fw-bold @(recoupmentMonths <= 36 ? "text-success" : "text-danger")">
                            @recoupmentMonths months
                            @if (recoupmentMonths <= 36)
                            {
                                <span class="badge bg-success ms-2">✓ Under 36</span>
                            }
                            else
                            {
                                <span class="badge bg-danger ms-2">✗ Over 36 limit</span>
                            }
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><span class="oi oi-info"></span> NTB Requirements</h6>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled mb-0">
                        <li class="mb-2">
                            <span class="@(currentLoanType == "Fixed" && rateReduction >= 0.5m ? "text-success" : currentLoanType == "ARM" ? "text-muted" : "text-danger")">
                                @if (currentLoanType == "Fixed" && rateReduction >= 0.5m)
                                {
                                    <span class="oi oi-check"></span>
                                }
                                else if (currentLoanType == "Fixed")
                                {
                                    <span class="oi oi-x"></span>
                                }
                                else
                                {
                                    <span>-</span>
                                }
                            </span>
                            <strong>Fixed-to-Fixed:</strong> 0.5% rate reduction
                        </li>
                        <li class="mb-2">
                            <span class="@(monthlySavings > 0 ? "text-success" : "text-danger")">
                                @if (monthlySavings > 0)
                                {
                                    <span class="oi oi-check"></span>
                                }
                                else
                                {
                                    <span class="oi oi-x"></span>
                                }
                            </span>
                            <strong>Payment Reduction:</strong> Lower monthly payment
                        </li>
                        <li class="mb-2">
                            <span class="@(recoupmentMonths <= 36 ? "text-success" : "text-danger")">
                                @if (recoupmentMonths <= 36)
                                {
                                    <span class="oi oi-check"></span>
                                }
                                else
                                {
                                    <span class="oi oi-x"></span>
                                }
                            </span>
                            <strong>Recoupment:</strong> ≤36 months
                        </li>
                    </ul>
                </div>
            </div>
        }
        else
        {
            <div class="card">
                <div class="card-body text-center py-5">
                    <span class="oi oi-calculator" style="font-size: 3rem; opacity: 0.3;"></span>
                    <p class="text-muted mt-3">Enter loan details and click "Calculate NTB" to see results</p>
                </div>
            </div>
        }
    </div>
</div>

@code {
    [Parameter]
    public ApplicationFormModel Application { get; set; } = new();

    // Current Loan
    private decimal currentLoanAmount;
    private decimal currentInterestRate;
    private decimal currentMonthlyPayment;
    private int currentRemainingTerm;
    private string currentLoanType = "Fixed";

    // New Loan
    private decimal newLoanAmount;
    private decimal newInterestRate;
    private int newTerm = 360;
    private decimal closingCosts = 3000;
    private string disabilityRating = "0";

    // Results
    private bool calculated = false;
    private bool meetsNTB = false;
    private decimal rateReduction;
    private decimal newMonthlyPayment;
    private decimal monthlySavings;
    private decimal annualSavings;
    private decimal fundingFee;
    private decimal totalCosts;
    private int recoupmentMonths;

    protected override void OnInitialized()
    {
        // Pre-populate from application
        currentLoanAmount = Application.CurrentLoanAmount;
        currentInterestRate = Application.CurrentInterestRate;
        currentMonthlyPayment = Application.CurrentMonthlyPayment;
        currentRemainingTerm = Application.RemainingTermMonths;
        
        newLoanAmount = currentLoanAmount;
        newInterestRate = 3.5m; // Default estimated rate
        newTerm = currentRemainingTerm;

        if (!string.IsNullOrEmpty(Application.VADisabilityRating) && Application.VADisabilityRating != "0%")
        {
            disabilityRating = "10";
        }
    }

    private void Calculate()
    {
        // Calculate rate reduction
        rateReduction = currentInterestRate - newInterestRate;

        // Calculate funding fee
        fundingFee = disabilityRating == "10" ? 0 : newLoanAmount * 0.005m;

        // Adjust loan amount if funding fee is rolled in
        var finalLoanAmount = newLoanAmount + fundingFee;

        // Calculate new monthly payment using simple formula
        // M = P * [r(1+r)^n] / [(1+r)^n - 1]
        var monthlyRate = newInterestRate / 100 / 12;
        if (monthlyRate > 0)
        {
            newMonthlyPayment = finalLoanAmount * (monthlyRate * (decimal)Math.Pow((double)(1 + monthlyRate), newTerm)) / 
                                ((decimal)Math.Pow((double)(1 + monthlyRate), newTerm) - 1);
        }
        else
        {
            newMonthlyPayment = finalLoanAmount / newTerm;
        }

        // Calculate savings
        monthlySavings = currentMonthlyPayment - newMonthlyPayment;
        annualSavings = monthlySavings * 12;

        // Calculate total costs
        totalCosts = closingCosts + fundingFee;

        // Calculate recoupment period
        recoupmentMonths = monthlySavings > 0 ? (int)Math.Ceiling((double)(totalCosts / monthlySavings)) : 999;

        // Determine if meets NTB
        if (currentLoanType == "Fixed")
        {
            // Fixed-to-Fixed: Need 0.5% reduction AND recoupment ≤36 months
            meetsNTB = rateReduction >= 0.5m && recoupmentMonths <= 36;
        }
        else
        {
            // ARM-to-Fixed: Just need payment reduction and recoupment ≤36 months
            meetsNTB = monthlySavings > 0 && recoupmentMonths <= 36;
        }

        calculated = true;
    }
}

