@inject IJSRuntime JS

<div class="row">
    <div class="col-12">
        <div class="alert alert-secondary mb-4">
            <h5><span class="oi oi-comment-square"></span> Internal Notes & Communication</h5>
            <p class="mb-0">Track your progress, document conversations with the veteran, and leave notes for underwriters or other loan officers.</p>
        </div>
    </div>
</div>

<div class="row">
    <!-- Add New Note -->
    <div class="col-lg-8 mb-3">
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0"><span class="oi oi-pencil"></span> Add New Note</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Note Type</label>
                    <select class="form-select" @bind="newNoteType">
                        <option value="General">General Note</option>
                        <option value="VeteranContact">Veteran Contact Log</option>
                        <option value="DocumentStatus">Document Status Update</option>
                        <option value="Calculation">Calculation/Analysis</option>
                        <option value="Underwriter">Note for Underwriter</option>
                        <option value="Issue">Issue/Problem</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Note Content</label>
                    <textarea class="form-control" rows="4" @bind="newNoteContent" placeholder="Enter your note here..."></textarea>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="markImportant" @bind="newNoteImportant">
                        <label class="form-check-label" for="markImportant">
                            Mark as Important
                        </label>
                    </div>
                    <button class="btn btn-primary" @onclick="AddNote" disabled="@string.IsNullOrWhiteSpace(newNoteContent)">
                        <span class="oi oi-plus"></span> Add Note
                    </button>
                </div>
            </div>
        </div>

        <!-- Notes Timeline -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><span class="oi oi-list"></span> Notes History</h5>
                <div>
                    <button class="btn btn-sm btn-outline-secondary" @onclick="() => showAllNotes = !showAllNotes">
                        @(showAllNotes ? "Show Recent" : "Show All")
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                @if (filteredNotes.Any())
                {
                    <div class="timeline">
                        @foreach (var note in filteredNotes)
                        {
                            <div class="timeline-item @(note.IsImportant ? "important" : "")">
                                <div class="timeline-marker @GetNoteTypeColor(note.Type)"></div>
                                <div class="timeline-content">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <div>
                                            <span class="badge @GetNoteTypeBadgeClass(note.Type) me-2">@note.Type</span>
                                            @if (note.IsImportant)
                                            {
                                                <span class="badge bg-danger">‚≠ê Important</span>
                                            }
                                        </div>
                                        <div class="text-end">
                                            <small class="text-muted">
                                                <strong>@note.CreatedBy</strong><br />
                                                @note.CreatedDate.ToString("MM/dd/yyyy hh:mm tt")
                                            </small>
                                        </div>
                                    </div>
                                    <div class="note-content">
                                        @note.Content
                                    </div>
                                    <div class="mt-2">
                                        <button class="btn btn-sm btn-link text-danger p-0" @onclick="() => DeleteNote(note.Id)">
                                            <span class="oi oi-trash"></span> Delete
                                        </button>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="text-center py-4">
                        <span class="oi oi-document" style="font-size: 3rem; opacity: 0.3;"></span>
                        <p class="text-muted mt-3">No notes yet. Add your first note above.</p>
                    </div>
                }
            </div>
            @if (notes.Count > 5 && !showAllNotes)
            {
                <div class="card-footer text-center">
                    <button class="btn btn-sm btn-link" @onclick="() => showAllNotes = true">
                        View All @notes.Count Notes
                    </button>
                </div>
            }
        </div>
    </div>

    <!-- Quick Stats & Templates -->
    <div class="col-lg-4 mb-3">
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0"><span class="oi oi-graph"></span> Notes Summary</h6>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6 mb-3">
                        <div class="fs-3 fw-bold text-primary">@notes.Count</div>
                        <small class="text-muted">Total Notes</small>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="fs-3 fw-bold text-danger">@notes.Count(n => n.IsImportant)</div>
                        <small class="text-muted">Important</small>
                    </div>
                    <div class="col-6">
                        <div class="fs-4 fw-bold text-success">@notes.Count(n => n.Type == "VeteranContact")</div>
                        <small class="text-muted">Contacts</small>
                    </div>
                    <div class="col-6">
                        <div class="fs-4 fw-bold text-warning">@notes.Count(n => n.Type == "Issue")</div>
                        <small class="text-muted">Issues</small>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0"><span class="oi oi-document"></span> Quick Templates</h6>
            </div>
            <div class="card-body">
                <small class="text-muted d-block mb-2">Click to insert template:</small>
                <div class="d-grid gap-2">
                    <button class="btn btn-sm btn-outline-secondary text-start" @onclick='() => UseTemplate("Called veteran to discuss application. Left voicemail.")'>
                        üìû Voicemail Left
                    </button>
                    <button class="btn btn-sm btn-outline-secondary text-start" @onclick='() => UseTemplate("Spoke with veteran. All questions answered. Waiting on documents.")'>
                        ‚úÖ Call Complete
                    </button>
                    <button class="btn btn-sm btn-outline-secondary text-start" @onclick='() => UseTemplate("Emailed document request list to veteran. Awaiting response.")'>
                        üìß Documents Requested
                    </button>
                    <button class="btn btn-sm btn-outline-secondary text-start" @onclick='() => UseTemplate("Reviewed all documents. Application ready for underwriting.")'>
                        ‚úì Ready for UW
                    </button>
                    <button class="btn btn-sm btn-outline-secondary text-start" @onclick='() => UseTemplate("Issue identified - requires follow-up with veteran before proceeding.")'>
                        ‚ö†Ô∏è Issue Found
                    </button>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><span class="oi oi-info"></span> Best Practices</h6>
            </div>
            <div class="card-body">
                <ul class="small mb-0 ps-3">
                    <li class="mb-2">Document all veteran contacts</li>
                    <li class="mb-2">Mark important items for underwriter review</li>
                    <li class="mb-2">Note calculation assumptions</li>
                    <li>Record any special circumstances</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<style>
    .timeline {
        position: relative;
        padding: 1rem 0;
    }
    .timeline-item {
        position: relative;
        padding-left: 3rem;
        padding-bottom: 2rem;
        border-left: 2px solid #dee2e6;
        margin-left: 1rem;
    }
    .timeline-item:last-child {
        border-left: none;
        padding-bottom: 0;
    }
    .timeline-item.important {
        border-left-color: #dc3545;
    }
    .timeline-marker {
        position: absolute;
        left: -0.6rem;
        width: 1rem;
        height: 1rem;
        border-radius: 50%;
        background-color: #0071bc;
        border: 2px solid white;
    }
    .timeline-marker.danger {
        background-color: #dc3545;
    }
    .timeline-marker.warning {
        background-color: #ffc107;
    }
    .timeline-marker.success {
        background-color: #28a745;
    }
    .timeline-content {
        background-color: #f8f9fa;
        padding: 1rem;
        border-radius: 0.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .note-content {
        white-space: pre-wrap;
        line-height: 1.6;
    }
</style>

@code {
    [Parameter]
    public int ApplicationId { get; set; }

    [Parameter]
    public int NotesCount { get; set; }

    [Parameter]
    public EventCallback<int> NotesCountChanged { get; set; }

    private List<Note> notes = new();
    private bool showAllNotes = false;

    private string newNoteType = "General";
    private string newNoteContent = "";
    private bool newNoteImportant = false;

    private List<Note> filteredNotes =>
        showAllNotes ? notes : notes.Take(5).ToList();

    protected override async Task OnInitializedAsync()
    {
        await LoadNotes();
        await UpdateNotesCount();
    }

    private async Task LoadNotes()
    {
        // TODO: Load from database
        // Simulated data
        notes = new List<Note>
        {
            new Note
            {
                Id = 1,
                Type = "VeteranContact",
                Content = "Initial call with John Smith to review application. Discussed timeline and next steps. Veteran expects closing in 30-45 days.",
                CreatedBy = "LO Smith",
                CreatedDate = DateTime.Now.AddHours(-3),
                IsImportant = false
            },
            new Note
            {
                Id = 2,
                Type = "DocumentStatus",
                Content = "Received pay stubs and driver's license via email. Still waiting on COE and bank statements.",
                CreatedBy = "LO Smith",
                CreatedDate = DateTime.Now.AddHours(-2),
                IsImportant = false
            },
            new Note
            {
                Id = 3,
                Type = "Calculation",
                Content = "Ran NTB calculator with 3.5% rate. Monthly savings: $247. Recoupment: 12 months. Meets all VA requirements.",
                CreatedBy = "LO Smith",
                CreatedDate = DateTime.Now.AddHours(-1),
                IsImportant = true
            }
        };

        await Task.CompletedTask;
    }

    private async Task UpdateNotesCount()
    {
        if (notes.Count != NotesCount)
        {
            NotesCount = notes.Count;
            await NotesCountChanged.InvokeAsync(NotesCount);
        }
    }

    private async Task AddNote()
    {
        if (!string.IsNullOrWhiteSpace(newNoteContent))
        {
            var note = new Note
            {
                Id = notes.Any() ? notes.Max(n => n.Id) + 1 : 1,
                Type = newNoteType,
                Content = newNoteContent,
                CreatedBy = "Current User", // TODO: Get from auth context
                CreatedDate = DateTime.Now,
                IsImportant = newNoteImportant
            };

            notes.Insert(0, note); // Add to top of list
            
            // Reset form
            newNoteContent = "";
            newNoteImportant = false;
            newNoteType = "General";

            await UpdateNotesCount();
        }
    }

    private void UseTemplate(string template)
    {
        newNoteContent = template;
    }

    private async Task DeleteNote(int noteId)
    {
        if (await JS.InvokeAsync<bool>("confirm", "Are you sure you want to delete this note?"))
        {
            var note = notes.FirstOrDefault(n => n.Id == noteId);
            if (note != null)
            {
                notes.Remove(note);
                await UpdateNotesCount();
            }
        }
    }

    private string GetNoteTypeBadgeClass(string type) => type switch
    {
        "VeteranContact" => "bg-primary",
        "DocumentStatus" => "bg-info",
        "Calculation" => "bg-success",
        "Underwriter" => "bg-warning text-dark",
        "Issue" => "bg-danger",
        _ => "bg-secondary"
    };

    private string GetNoteTypeColor(string type) => type switch
    {
        "Issue" => "danger",
        "Underwriter" => "warning",
        "Calculation" => "success",
        _ => ""
    };

    private class Note
    {
        public int Id { get; set; }
        public string Type { get; set; } = "";
        public string Content { get; set; } = "";
        public string CreatedBy { get; set; } = "";
        public DateTime CreatedDate { get; set; }
        public bool IsImportant { get; set; }
    }
}

